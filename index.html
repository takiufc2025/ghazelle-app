<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHAZELLE COLLECTION - Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª</title>
    <style>
        :root { --primary-blue: #1e293b; --accent-blue: #3b82f6; --success-green: #10b981; --bg-light: #f1f5f9; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg-light); margin: 0; display: flex; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 500px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .header { background-color: var(--primary-blue); color: white; padding: 20px; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .logo { width: 70px; height: auto; border-radius: 8px; }
        .header h1 { margin: 0; font-size: 1.2rem; }
        .form-content { padding: 25px; }
        .section-title { font-size: 1rem; font-weight: bold; color: var(--primary-blue); margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .form-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; border: 1.5px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .allow-box { background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px dashed var(--accent-blue); display: flex; align-items: center; gap: 10px; margin-bottom: 15px; cursor: pointer; }
        .allow-box input { width: 20px; height: 20px; cursor: pointer; }
        .allow-box label { font-weight: bold; color: var(--primary-blue); cursor: pointer; }
        .delivery-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .option-card { border: 2px solid #e2e8f0; border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; }
        .option-card.active { border-color: var(--accent-blue); background-color: #eff6ff; color: var(--accent-blue); }
        .submit-btn { width: 100%; padding: 16px; background-color: var(--success-green); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }
        #msg { text-align: center; margin-top: 15px; font-weight: bold; color: var(--success-green); }
        .custom-input { margin-top: 5px; border-color: var(--accent-blue); background: #fffdf0; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <img src="https://i.ibb.co/Gf0SMJr2/GHAZELLE-COLLECTION.webp" alt="Logo" class="logo">
        <div class="header-text"><h1>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª</h1><p>GHAZELLE COLLECTION SYSTEM</p></div>
    </div>
    <form id="orderForm" class="form-content">
        <div class="section-title">ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ†</div>
        <div class="form-group"><input type="text" name="firstname" placeholder="Ø§Ù„Ø§Ø³Ù…" required></div>
        <div class="form-group"><input type="text" name="familyname" placeholder="Ø§Ù„Ù„Ù‚Ø¨" required></div>
        <div class="form-group"><input type="tel" name="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required></div>

        <div class="section-title">ğŸ‘— ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</div>
        
        <div class="form-group">
            <select name="model_select" id="model_select" onchange="toggleCustom(this, 'custom_model_div')" required>
                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ --</option>
                <option value="Noor">Noor</option><option value="Ghazelle">Ghazelle</option><option value="Miral">Miral</option>
                <option value="Hiba">Hiba</option><option value="Miral perlÃ©">Miral perlÃ©</option><option value="Rihanna">Rihanna</option><option value="Rahaf">Rahaf</option>
                <option value="OTHER">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯Ø§Ù„ Ø¢Ø®Ø±...</option>
            </select>
            <div id="custom_model_div" class="hidden"><input type="text" id="custom_model" class="custom-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯"></div>
        </div>
        
        <div style="display: flex; gap: 10px;" class="form-group">
            <div style="flex: 2;">
                <select name="color_select" id="color_select" onchange="toggleCustom(this, 'custom_color_div')" required>
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ† --</option>
                    <option value="Rouge - Ø£Ø­Ù…Ø±">Rouge - Ø£Ø­Ù…Ø±</option>
                    <option value="Blue - Ø£Ø²Ø±Ù‚">Blue - Ø£Ø²Ø±Ù‚</option>
                    <option value="Vert - Ø£Ø®Ø¶Ø±">Vert - Ø£Ø®Ø¶Ø±</option>
                    <option value="Noir - Ø£Ø³ÙˆØ¯">Noir - Ø£Ø³ÙˆØ¯</option>
                    <option value="Blanc - Ø£Ø¨ÙŠØ¶">Blanc - Ø£Ø¨ÙŠØ¶</option>
                    <option value="Rose - ÙˆØ±Ø¯ÙŠ">Rose - ÙˆØ±Ø¯ÙŠ</option>
                    <option value="Marron - Ø¨Ù†ÙŠ">Marron - Ø¨Ù†ÙŠ</option>
                    <option value="Beige - Ø¨ÙŠØ¬">Beige - Ø¨ÙŠØ¬</option>
                    <option value="DorÃ© - Ø°Ù‡Ø¨ÙŠ">DorÃ© - Ø°Ù‡Ø¨ÙŠ</option>
                    <option value="ArgentÃ© - ÙØ¶ÙŠ">ArgentÃ© - ÙØ¶ÙŠ</option>
                    <option value="Blue clair - Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­">Blue clair - Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­</option>
                    <option value="Blue roi - Ø£Ø²Ø±Ù‚ Ù…Ù„ÙƒÙŠ">Blue roi - Ø£Ø²Ø±Ù‚ Ù…Ù„ÙƒÙŠ</option>
                    <option value="Vert foncÃ© - Ø£Ø®Ø¶Ø± ØºØ§Ù…Ù‚">Vert foncÃ© - Ø£Ø®Ø¶Ø± ØºØ§Ù…Ù‚</option>
                    <option value="Vert olive - Ø£Ø®Ø¶Ø± Ø²ÙŠØªÙˆÙ†ÙŠ">Vert olive - Ø£Ø®Ø¶Ø± Ø²ÙŠØªÙˆÙ†ÙŠ</option>
                    <option value="Vert d'eau - Ø£Ø®Ø¶Ø± Ù…Ø§Ø¦ÙŠ">Vert d'eau - Ø£Ø®Ø¶Ø± Ù…Ø§Ø¦ÙŠ</option>
                    <option value="Blanc cassÃ© - Ø£Ø¨ÙŠØ¶ ÙƒØ§Ø³ÙŠ">Blanc cassÃ© - Ø£Ø¨ÙŠØ¶ ÙƒØ§Ø³ÙŠ</option>
                    <option value="OTHER">Ù„ÙˆÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯...</option>
                </select>
                <div id="custom_color_div" class="hidden"><input type="text" id="custom_color" class="custom-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù„ÙˆÙ† (FR)"></div>
            </div>

            <div style="flex: 1.5;">
                <select name="size_select" id="size_select" onchange="toggleCustom(this, 'custom_size_div')" required>
                    <option value="">-- Ø§Ù„Ù…Ù‚Ø§Ø³ --</option>
                    <option value="36">36</option><option value="38">38</option><option value="40">40</option><option value="42">42</option>
                    <option value="44">44</option><option value="46">46</option><option value="48">48</option>
                    <option value="OTHER">Ø¢Ø®Ø±...</option>
                </select>
                <div id="custom_size_div" class="hidden"><input type="text" id="custom_size" class="custom-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù‚Ø§Ø³"></div>
            </div>
        </div>

        <div class="allow-box">
            <input type="checkbox" id="allow_opening">
            <label for="allow_opening">âœ… Ù…Ø³Ù…ÙˆØ­ Ø¨ÙØªØ­ Ø§Ù„Ø·Ø±Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</label>
        </div>

        <div class="section-title">ğŸšš Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø´Ø­Ù†</div>
        <div class="delivery-options">
            <div class="option-card" id="homeOpt" onclick="setDelivery('adomicile')">ğŸ <br>ØªÙˆØµÙŠÙ„ Ù…Ù†Ø²Ù„ÙŠ</div>
            <div class="option-card" id="deskOpt" onclick="setDelivery('stop desk')">ğŸ¢<br>Ù…ÙƒØªØ¨ ÙŠØ§Ù„ÙŠØ¯ÙŠÙ†</div>
        </div>
        <input type="hidden" name="delivery_type" id="delivery_type" required>

        <div id="locationFields" class="hidden">
            <div class="form-group"><select name="wilaya" id="wilaya" onchange="initCommunes()" required></select></div>
            <div class="form-group"><select name="commune" id="commune" onchange="initOffices()" required></select></div>
            <div id="officeDiv" class="hidden"><select id="office" onchange="setOfficeId()"></select></div>
        </div>
        <input type="hidden" name="stopdesk_id" id="stopdesk_id">
        <button type="submit" id="btn" class="submit-btn">+ ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <div id="msg"></div>
    </form>
</div>

<script>
let data = [];

// Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ§Ù„ÙŠØ¯ÙŠÙ† Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
window.onload = async () => {
    try {
        const response = await fetch('/api/yalidine-data');
        data = await response.json();
        console.log("Data loaded successfully");
    } catch (e) {
        console.error("Error loading data:", e);
    }
};

function toggleCustom(select, divId) {
    const div = document.getElementById(divId);
    const input = div.querySelector('input');
    if (select.value === "OTHER") { div.classList.remove('hidden'); input.required = true; }
    else { div.classList.add('hidden'); input.required = false; }
}

function setDelivery(type) {
    document.getElementById('delivery_type').value = type;
    document.getElementById('homeOpt').classList.toggle('active', type === 'adomicile');
    document.getElementById('deskOpt').classList.toggle('active', type === 'stop desk');
    document.getElementById('locationFields').classList.remove('hidden');
    const wSelect = document.getElementById('wilaya');
    wSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ© --</option>';
    [...new Set(data.map(r => r[1]))].sort().forEach(w => wSelect.add(new Option(w, w)));
}

function initCommunes() {
    const type = document.getElementById('delivery_type').value;
    const w = document.getElementById('wilaya').value;
    const cSelect = document.getElementById('commune');
    cSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© --</option>';
    if(!w) return;
    let filtered = (type === "stop desk")
        ? [...new Set(data.filter(r => r[1] === w && r[3].toLowerCase().includes("agence")).map(r => r[2]))].sort()
        : [...new Set(data.filter(r => r[1] === w).map(r => r[2]))].sort();
    filtered.forEach(c => cSelect.add(new Option(c, c)));
}

function initOffices() {
    const type = document.getElementById('delivery_type').value;
    const w = document.getElementById('wilaya').value;
    const c = document.getElementById('commune').value;
    const oSelect = document.getElementById('office');
    const oDiv = document.getElementById('officeDiv');
    if (type === "stop desk" && c) {
        oSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØªØ¨ --</option>';
        const offices = data.filter(r => r[1] === w && r[2] === c && r[3].toLowerCase().includes("agence"));
        if(offices.length > 0) { oDiv.classList.remove('hidden'); offices.forEach(r => { let opt = new Option(r[3], r[3]); opt.dataset.id = r[0]; oSelect.add(opt); }); }
    } else { oDiv.classList.add('hidden'); }
}

function setOfficeId() {
    const o = document.getElementById('office');
    document.getElementById('stopdesk_id').value = o.options[o.selectedIndex].dataset.id || "";
}

document.getElementById('orderForm').onsubmit = async function(e) {
    e.preventDefault();
    const b = document.getElementById('btn');
    const msgDiv = document.getElementById('msg');
    b.disabled = true; b.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
    
    let finalModel = this.model_select.value === "OTHER" ? document.getElementById('custom_model').value : this.model_select.value;
    let finalSize = this.size_select.value === "OTHER" ? document.getElementById('custom_size').value : this.size_select.value;
    let colorVal = this.color_select.value;
    let finalColor = colorVal === "OTHER" ? document.getElementById('custom_color').value : (colorVal.includes(" - ") ? colorVal.split(" - ")[0] : colorVal);

    let descParts = [finalModel.trim(), finalColor.trim(), finalSize.trim()];
    if(document.getElementById('allow_opening').checked) descParts.push("Ù…Ø³Ù…ÙˆØ­ Ø§Ù„ÙØªØ­");
    const finalDesc = descParts.filter(p => p !== "").join(" * ");

    const payload = {
        firstname: this.firstname.value,
        familyname: this.familyname.value,
        phone: this.phone.value,
        delivery_type: this.delivery_type.value,
        wilaya: this.wilaya.value,
        commune: this.commune.value,
        stopdesk_id: this.stopdesk_id.value,
        description: finalDesc
    };

    try {
        const response = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.text();
        msgDiv.innerText = result;
        this.reset();
        ['custom_model_div', 'custom_color_div', 'custom_size_div', 'locationFields'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.querySelectorAll('.option-card').forEach(el => el.classList.remove('active'));
    } catch (err) {
        msgDiv.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±";
    } finally {
        b.disabled = false;
        b.innerText = "+ ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©";
        setTimeout(() => { msgDiv.innerText = ""; }, 5000);
    }
};
</script>
</body>
</html>
